From c239c0f86240c166fe684c08b64ff71f93e86f92 Mon Sep 17 00:00:00 2001
From: Shaun Tancheff <shaun@tancheff.com>
Date: Fri, 18 Mar 2016 17:48:23 -0500
Subject: [PATCH 2/3] Fix arg parsing/ioctl.

---
 sys-utils/blkreport.c  | 12 ++++++------
 sys-utils/blkzonecmd.c | 22 ++++++++++++----------
 2 files changed, 18 insertions(+), 16 deletions(-)

diff --git a/sys-utils/blkreport.c b/sys-utils/blkreport.c
index c4fdf81..7518063 100644
--- a/sys-utils/blkreport.c
+++ b/sys-utils/blkreport.c
@@ -452,10 +452,10 @@ int main(int argc, char **argv)
 	static const struct option longopts[] = {
 	    { "help",      0, 0, 'h' },
 	    { "version",   0, 0, 'V' },
-	    { "offset",    1, 0, 'o' }, /* starting LBA */
+	    { "zone",      1, 0, 'z' }, /* starting LBA */
 	    { "length",    1, 0, 'l' }, /* max #of bytes for result */
-	    { "ata",       1, 0, 'a' }, /* use ATA passthrough */
 	    { "option",    1, 0, 'r' }, /* report option */
+	    { "ata",       0, 0, 'a' }, /* use ATA passthrough */
 	    { "verbose",   0, 0, 'v' },
 	    { NULL,        0, 0, 0 }
 	};
@@ -465,7 +465,7 @@ int main(int argc, char **argv)
 	textdomain(PACKAGE);
 	atexit(close_stdout);
 
-	while ((c = getopt_long(argc, argv, "hVsvo:l:r:a", longopts, NULL)) != -1) {
+	while ((c = getopt_long(argc, argv, "ahVsvz:l:r:", longopts, NULL)) != -1) {
 		switch(c) {
 		case 'h':
 			usage(stdout);
@@ -474,11 +474,11 @@ int main(int argc, char **argv)
 			printf(UTIL_LINUX_VERSION);
 			return EXIT_SUCCESS;
 		case 'l':
-			length = strtosize_or_err(optarg,
+			length = strtou64_base_or_err(0, optarg,
 					_("failed to parse length"));
 			break;
-		case 'o':
-			offset = strtou64_or_err(optarg,
+		case 'z':
+			offset = strtou64_base_or_err(0, optarg,
 					_("failed to parse offset"));
 			break;
 		case 'r':
diff --git a/sys-utils/blkzonecmd.c b/sys-utils/blkzonecmd.c
index 28c31c3..5d2b8d6 100644
--- a/sys-utils/blkzonecmd.c
+++ b/sys-utils/blkzonecmd.c
@@ -155,7 +155,7 @@ int main(int argc, char **argv)
 			printf(UTIL_LINUX_VERSION);
 			return EXIT_SUCCESS;
 		case 'z':
-			zone_lba = strtosize_or_err(optarg,
+			zone_lba = strtou64_base_or_err(0, optarg,
 					_("failed to parse length"));
 			break;
 		case 'a':
@@ -203,14 +203,16 @@ int main(int argc, char **argv)
 	if (ioctl(fd, BLKSSZGET, &secsize))
 		err(EXIT_FAILURE, _("%s: BLKSSZGET ioctl failed"), path);
 
-	/* check offset alignment to the sector size */
-	if (zone_lba % secsize)
-		errx(EXIT_FAILURE, _("%s: offset %" PRIu64 " is not aligned "
-			 "to sector size %i"), path, zone_lba, secsize);
+	if (zone_lba != ~0ul) {
+		/* check offset alignment to the sector size */
+		if (zone_lba % secsize)
+			errx(EXIT_FAILURE, _("%s: offset %" PRIu64 " is not aligned "
+				 "to sector size %i"), path, zone_lba, secsize);
 
-	/* is the range end behind the end of the device ?*/
-	if (zone_lba > blksize)
-		errx(EXIT_FAILURE, _("%s: offset is greater than device size"), path);
+		/* is the range end behind the end of the device ?*/
+		if (zone_lba > blksize)
+			errx(EXIT_FAILURE, _("%s: offset is greater than device size"), path);
+	}
 
 	if (ata) {
 		zone_lba |= 1ul; /* ensure low bit is set */
@@ -224,8 +226,8 @@ int main(int argc, char **argv)
 			 err(EXIT_FAILURE, _("%s: BLKOPENZONE ioctl failed"), path);
 		break;
 	case ACT_CLOSE_ZONE:
-		if (ioctl(fd, ACT_CLOSE_ZONE, zone_lba))
-			err(EXIT_FAILURE, _("%s: BLKSECDISCARD ioctl failed"), path);
+		if (ioctl(fd, BLKCLOSEZONE, zone_lba))
+			err(EXIT_FAILURE, _("%s: BLKCLOSEZONE ioctl failed"), path);
 		break;
 
 	case ACT_RESET_ZONE:
-- 
2.7.0

